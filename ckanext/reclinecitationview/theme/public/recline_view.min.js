this.ckan.module("recline_view",function(e){return{options:{site_url:"",controlsClassName:"controls",dataproxyUrl:"//jsonpdataproxy.appspot.com"},onCiteSubset:function(e){ds=e.data.dataset,resource_id=e.data.resource_id,attributes=e.data.dataset.queryState.attributes,prepared_filters={},attributes.filters.forEach(function(e){prepared_filters[e.field]=e.term}),e.data.client.call("POST","issue_pid",{resource_id:resource_id,statement:prepared_filters,sort:attributes.sort},function(e){url="/querystore/view_query?id="+e.result,$("#cite-response-text").html('A background job was triggerd to calculate the hash value of the resultset. Once the job was successful all meta information of the subset can be found <a target="_blank" href=\''+url+"'>here</a>"),$("#cite-response-panel").fadeIn()})},query:null,initialize:function(){e.proxyAll(this,/_on/),this.options.resource=JSON.parse(this.options.resource),this.options.resourceView=JSON.parse(this.options.resourceView),this.el.ready(this._onReady),L.Icon.Default.imagePath=this.options.site_url+"vendor/leaflet/0.7.7/images"},_onReady:function(){var e=this.options.resource,t=this.options.resourceView;this.loadView(e,t)},loadView:function(t,i){var a,r,o=this;if(""===t.formatNormalized){var n=t.url.split("/"),s=(n=(n=(n=n[n.length-1]).split("?"))[0]).split(".");s.length>1&&(t.formatNormalized=s[s.length-1])}t.datastore_active?(t.backend="ckan",t.endpoint=e("body").data("site-root")+"api"):(recline.Backend.DataProxy.timeout=1e4,recline.Backend.DataProxy.dataproxy_url=this.options.dataproxyUrl,t.backend="dataproxy"),r=new recline.Model.Dataset(t),this.options.map_config,query=new recline.Model.Query,query.set({size:i.limit||100}),query.set({from:i.offset||0});var l={};try{window.parent.ckan.views&&window.parent.ckan.views.filters&&(l=window.parent.ckan.views.filters.get())}catch(e){}var d=i.filters||{},p=e.extend({},d,l);e.each(p,function(e,t){query.addFilter({type:"term",field:e,term:t})}),r.queryState.set(query.toJSON(),{silent:!0}),a=this._("Could not load view")+": ","ckan"==t.backend?a+=this._("DataStore returned an error"):"dataproxy"==t.backend&&(a+=this._("DataProxy returned an error")),r.fetch().done(function(e){o.initializeView(e,i)}).fail(function(e){var t;e.message&&(a+=" ("+e.message+")"),t=(t=a)||o._("error loading view"),window.parent.ckan.pubsub.publish("data-viewer-error",t)})},initializeView:function(t,i){var a,r,o=[];if(this.$("#cite-btn").click({dataset:t,resource_id:this.options.resource.id,client:this.sandbox.client},this.onCiteSubset),"recline_graph_view"===i.view_type?(r={graphType:i.graph_type,group:i.group,series:[i.series]},a=new recline.View.Graph({model:t,state:r})):"recline_map_view"===i.view_type?(r={geomField:null,latField:null,lonField:null,autoZoom:Boolean(i.auto_zoom),cluster:Boolean(i.cluster_markers)},"geojson"===i.map_field_type?r.geomField=i.geojson_field:(r.latField=i.latitude_field,r.lonField=i.longitude_field),a=new recline.View.Map($.extend(this._reclineMapViewOptions(t,this.options.map_config),{state:r}))):"recline_view"===i.view_type?a=this._newDataExplorer(t,this.options.map_config):(a=new recline.View.SlickGrid({model:t}),o=[new recline.View.Pager({model:a.model}),new recline.View.RecordCount({model:t}),new recline.View.QueryEditor({model:a.model.queryState})]),"recline_view"!==i.view_type){var n=e("<div />");this._renderControls(n,o,this.options.controlsClassName),n.append(a.el),e(this.el).html(n),a.visible=!0,a.render()}"recline_graph_view"===i.view_type&&a.redraw()},_reclineMapViewOptions:function(e,t){var i,a,r;if(i=a=r="","mapbox"==t.type){if(!t["mapbox.map_id"]||!t["mapbox.access_token"])throw"[CKAN Map Widgets] You need to provide a map ID ([account].[handle]) and an access token when using a MapBox layer. See http://www.mapbox.com/developers/api-overview/ for details";i="//{s}.tiles.mapbox.com/v4/"+t["mapbox.map_id"]+"/{z}/{x}/{y}.png?access_token="+t["mapbox.access_token"],handle=t["mapbox.map_id"],r=t.subdomains||"abcd",a=t.attribution||'Data: <a href="http://osm.org/copyright" target="_blank">OpenStreetMap</a>, Design: <a href="http://mapbox.com/about/maps" target="_blank">MapBox</a>'}else if("custom"==t.type&&(i=t["custom.url"]||"",a=t.attribution||"",r=t.subdomains||"",t["custom.tms"]))t["custom.tms"];return{model:e,mapTilesURL:i,mapTilesAttribution:a,mapTilesSubdomains:r}},_newDataExplorer:function(e,t){var i=[{id:"grid",label:this._("Grid"),view:new recline.View.SlickGrid({model:e})},{id:"graph",label:this._("Graph"),view:new recline.View.Graph({model:e})},{id:"map",label:this._("Map"),view:new recline.View.Map(this._reclineMapViewOptions(e,t))}],a=[{id:"valueFilter",label:this._("Filters"),view:new recline.View.ValueFilter({model:e})}];return new recline.View.MultiView({el:this.$("#datagrid"),model:e,views:i,sidebarViews:a,config:{readOnly:!0}})},_renderControls:function(t,i,a){for(var r=e('<div class="clearfix '+a+'" />'),o=0;o<i.length;o++)r.append(i[o].el);e(t).append(r)}}});